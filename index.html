<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Fibre Coverage Map</title>
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.14.1/mapbox-gl.css" rel="stylesheet">
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.14.1/mapbox-gl.js"></script>
    <script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.0/mapbox-gl-geocoder.min.js"></script>
    <link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.0/mapbox-gl-geocoder.css" type="text/css">

    <style>
        body { margin: 0; padding: 0; height: 100vh; font-family: 'Segoe UI', sans-serif; overflow: hidden; }
        #map { position: absolute; top: 0; bottom: 0; width: 100%; }
        
        /* FLOATING SEARCH BAR */
        .mapboxgl-ctrl-geocoder {
            position: absolute !important; top: 20px; left: 50%; transform: translateX(-50%);
            width: 90%; max-width: 400px; z-index: 100; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.15) !important;
            border-radius: 30px !important;
        }
        .mapboxgl-ctrl-geocoder--input { padding-left: 40px !important; border-radius: 30px !important; height: 45px !important; }
        .mapboxgl-ctrl-geocoder--icon { top: 12px !important; }

        /* POPUP STYLING */
        .mapboxgl-popup-content { padding: 20px; text-align: center; border-radius: 12px; font-family: 'Segoe UI', sans-serif; min-width: 240px; box-shadow: 0 5px 20px rgba(0,0,0,0.2); }
        .connect-btn {
            background-color: #28a745; color: white; border: none; padding: 10px 0;
            border-radius: 6px; font-weight: bold; cursor: pointer; width: 100%; margin-top: 12px;
            font-size: 14px; transition: background 0.2s;
        }
        .connect-btn:hover { background-color: #218838; }
    </style>
</head>
<body>
    <div id="map"></div>
    <script>
    // 1. CONFIGURATION
    mapboxgl.accessToken = 'pk.eyJ1Ijoia2lhbmdvZ2xlIiwiYSI6ImNtbDluZ2d3bzA0ZGQzbHF1anFkZmFzYXoifQ.KOCzNuYVq65mO6RsP1Pkmw'; 
    var TILESET_ID = 'kiangogle.3r8297nc';
    var SOURCE_LAYER_NAME = 'MyOwn_ISP_Coverage_POC';

    // 2. FORM URL (The destination)
    var CONFIG = {
        baseUrl: "https://creatorapp.zoho.com/oceanblu813/environment/development/isp-management/#Form:New_Orders",
        fields: {
            address: "Address_Line_1",   
            provider: "Network_Provider",
            zone: "Zone_Category"
        }
    };
    
    var selectedData = {};

    // 3. INIT MAP
    const map = new mapboxgl.Map({
        container: 'map',
        style: 'mapbox://styles/mapbox/streets-v12',
        center: [28.0567, -26.1076], zoom: 12, attributionControl: false
    });

    const geocoder = new MapboxGeocoder({ accessToken: mapboxgl.accessToken, mapboxgl: mapboxgl, marker: false, placeholder: 'Search for your address...' });
    document.getElementById('map').appendChild(geocoder.onAdd(map));

    map.on('load', () => {
        map.addSource('my-isp-zones', { type: 'vector', url: 'mapbox://' + TILESET_ID });
        // Invisible fill layer for click detection
        map.addLayer({ 'id': 'coverage-fill', 'type': 'fill', 'source': 'my-isp-zones', 'source-layer': SOURCE_LAYER_NAME, 'paint': { 'fill-color': '#28a745', 'fill-opacity': 0.0 } });
        // Visible outline
        map.addLayer({ 'id': 'coverage-outline', 'type': 'line', 'source': 'my-isp-zones', 'source-layer': SOURCE_LAYER_NAME, 'paint': { 'line-color': '#28a745', 'line-width': 2 } });
    });

    geocoder.on('result', function(e) {
        map.flyTo({ center: e.result.geometry.coordinates, zoom: 16 });
        map.once('idle', function() { checkCoverageAtPoint(e.result.geometry.coordinates, e.result.place_name); });
    });

    map.on('click', (e) => {
        fetch("https://api.mapbox.com/geocoding/v5/mapbox.places/" + e.lngLat.lng + "," + e.lngLat.lat + ".json?access_token=" + mapboxgl.accessToken)
            .then(res => res.json()).then(data => {
                var address = data.features[0] ? data.features[0].place_name : "Pinned Location";
                checkCoverageAtPoint([e.lngLat.lng, e.lngLat.lat], address);
            });
    });

    function checkCoverageAtPoint(coords, addressText) {
        var point = map.project(coords);
        var features = map.queryRenderedFeatures(point, { layers: ['coverage-fill'] });
        var popups = document.getElementsByClassName('mapboxgl-popup');
        while(popups[0]) { popups[0].remove(); }

        if (features.length > 0) {
            var props = features[0].properties;
            var provider = "Ocean Blu"; 
            var desc = (props.Description || "").toLowerCase();
            if(desc.includes("vuma") || (props.Name && props.Name.toLowerCase().includes("vuma"))) provider = "Vumatel";

            selectedData = { provider: provider, zone: props.Name || "Standard", address: addressText };

            new mapboxgl.Popup({ closeButton: true, maxWidth: '300px' })
                .setLngLat(coords)
                .setHTML(`
                    <h3 style="margin:0 0 5px 0; color:#28a745">✅ ${provider} Available!</h3>
                    <div style="font-size:12px;color:#666;margin-bottom:5px;">${addressText}</div>
                    <button class="connect-btn" onclick="openOrderForm()">Get Connected</button>
                `)
                .addTo(map);
        } else {
            new mapboxgl.Popup({ closeButton: true })
                .setLngLat(coords)
                .setHTML(`<h3 style="margin:0; color:#dc3545">❌ No Coverage</h3><div style="font-size:12px;color:#666;margin-top:5px;">${addressText}</div>`)
                .addTo(map);
        }
    }

    // 4. OPEN FORM FUNCTION
    window.openOrderForm = function() {
        var url = CONFIG.baseUrl + 
                  "?" + CONFIG.fields.address + "=" + encodeURIComponent(selectedData.address) +
                  "&" + CONFIG.fields.provider + "=" + encodeURIComponent(selectedData.provider) +
                  "&" + CONFIG.fields.zone + "=" + encodeURIComponent(selectedData.zone);
        window.open(url, "_blank"); // Opens in new tab
    }
    </script>
</body>
</html>