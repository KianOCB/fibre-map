<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Fibre Coverage Map</title>
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.14.1/mapbox-gl.css" rel="stylesheet">
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.14.1/mapbox-gl.js"></script>
    <script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.0/mapbox-gl-geocoder.min.js"></script>
    <link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.0/mapbox-gl-geocoder.css" type="text/css">

    <style>
        body { margin: 0; padding: 0; height: 100vh; font-family: 'Segoe UI', sans-serif; overflow: hidden; }
        #map { position: absolute; top: 0; bottom: 0; width: 100%; }
        
        /* SEARCH BAR */
        .mapboxgl-ctrl-geocoder {
            position: absolute !important; top: 10px; left: 50%; transform: translateX(-50%);
            width: 90%; max-width: 400px; z-index: 100; box-shadow: 0 4px 12px rgba(0,0,0,0.15) !important;
            border-radius: 25px !important;
        }
        .mapboxgl-ctrl-geocoder--input { padding-left: 35px !important; border-radius: 25px !important; }

        /* POPUP */
        .mapboxgl-popup-content { padding: 15px; text-align: center; border-radius: 8px; font-family: 'Segoe UI', sans-serif; min-width: 200px; }
        .connect-btn {
            background-color: #007bff; color: white; border: none; padding: 8px 20px;
            border-radius: 4px; font-weight: bold; cursor: pointer; width: 100%; margin-top: 8px;
        }
        .connect-btn:hover { background-color: #0056b3; }
    </style>
</head>
<body>
    <div id="map"></div>
    <script>
    mapboxgl.accessToken = 'pk.eyJ1Ijoia2lhbmdvZ2xlIiwiYSI6ImNtbDluZ2d3bzA0ZGQzbHF1anFkZmFzYXoifQ.KOCzNuYVq65mO6RsP1Pkmw'; 
    var TILESET_ID = 'kiangogle.3r8297nc';
    var SOURCE_LAYER_NAME = 'MyOwn_ISP_Coverage_POC';
    
    var selectedData = {};

    const map = new mapboxgl.Map({
        container: 'map',
        style: 'mapbox://styles/mapbox/streets-v12',
        center: [28.0567, -26.1076], zoom: 12, attributionControl: false
    });

    const geocoder = new MapboxGeocoder({ accessToken: mapboxgl.accessToken, mapboxgl: mapboxgl, marker: false, placeholder: 'Search Address...' });
    document.getElementById('map').appendChild(geocoder.onAdd(map));

    map.on('load', () => {
        map.addSource('my-isp-zones', { type: 'vector', url: 'mapbox://' + TILESET_ID });
        map.addLayer({ 'id': 'coverage-fill', 'type': 'fill', 'source': 'my-isp-zones', 'source-layer': SOURCE_LAYER_NAME, 'paint': { 'fill-color': '#28a745', 'fill-opacity': 0.0 } });
    });

    geocoder.on('result', function(e) {
        map.flyTo({ center: e.result.geometry.coordinates, zoom: 16 });
        map.once('idle', function() { checkCoverageAtPoint(e.result.geometry.coordinates, e.result.place_name); });
    });

    map.on('click', (e) => {
        fetch("https://api.mapbox.com/geocoding/v5/mapbox.places/" + e.lngLat.lng + "," + e.lngLat.lat + ".json?access_token=" + mapboxgl.accessToken)
            .then(res => res.json()).then(data => {
                var address = data.features[0] ? data.features[0].place_name : "Pinned Location";
                checkCoverageAtPoint([e.lngLat.lng, e.lngLat.lat], address);
            });
    });

    function checkCoverageAtPoint(coords, addressText) {
        var point = map.project(coords);
        var features = map.queryRenderedFeatures(point, { layers: ['coverage-fill'] });
        var popups = document.getElementsByClassName('mapboxgl-popup');
        while(popups[0]) { popups[0].remove(); }

        if (features.length > 0) {
            var props = features[0].properties;
            var provider = "Ocean Blu"; // Default
            var desc = (props.Description || "").toLowerCase();
            if(desc.includes("vuma")) provider = "Vumatel";
            if(props.Name && props.Name.toLowerCase().includes("vuma")) provider = "Vumatel";

            selectedData = { provider: provider, zone: props.Name || "Standard", address: addressText };

            new mapboxgl.Popup({ closeButton: true, maxWidth: '300px' })
                .setLngLat(coords)
                .setHTML(`<h3>✅ ${provider} Available!</h3><div style="font-size:12px;color:#666">${addressText}</div><button class="connect-btn" onclick="sendDataToZoho()">Get Connected</button>`)
                .addTo(map);
        } else {
            new mapboxgl.Popup({ closeButton: true }).setLngLat(coords).setHTML(`<h3>❌ No Coverage</h3><div style="font-size:12px;color:#666">${addressText}</div>`).addTo(map);
        }
    }

    // THE MAGIC BRIDGE: Sends data to the parent window (Zoho)
    window.sendDataToZoho = function() {
        // We use '*' to allow sending to Zoho, but ideally this would be the Zoho domain
        window.parent.postMessage({
            type: "coverage_update",
            address: selectedData.address,
            provider: selectedData.provider,
            zone: selectedData.zone
        }, "*"); 
    }
    </script>
</body>
</html>